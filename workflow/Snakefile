configfile: "config.yaml"

rule all:
    input:
        expand("data/sra/sh1000/{srr_sh1000}/{srr_sh1000}.sra", \
                    srr_sh1000 = config["SRR_SH1000"]),
        expand("data/sra/atcc6538/{srr_atcc6538}/{srr_atcc6538}.sra", \
                    srr_atcc6538 = config["SRR_ATCC6538"]),
        expand("data/sra/st398/{srr_st398}/{srr_st398}.sra", \
                    srr_st398 = config["SRR_ST398"]),
        expand("data/sra/sh1000/{srr_sh1000}_{mate}.fastq.gz", \
                srr_sh1000 = config["SRR_SH1000"], mate = ["1", "2"]),
        expand("results/atcc6538/{atcc6538_lib}/{atcc6538_lib}.log", \
	        atcc6538_lib = config["ATCC6538_LIB"]),
        expand("results/st398/{st398_lib}/{st398_lib}.log", \
	        st398_lib = config["ST398_LIB"]),
        expand("results/sh1000/{sh1000_lib}/{sh1000_lib}.log", \
	        sh1000_lib = config["SH1000_LIB"]),
        "results/growth_data/20190906_gp_all.png",
        "results/growth_data/20190906_gp_no_sh.png",
        "results/growth_data/20190906_gp_sh.png",
        "results/growth_data/20190906_gp_sh_custom.png"

rule sra_atcc6538:
    input: "data/srr_atcc6538.txt"
    output: expand("data/sra/atcc6538/{srr_atcc6538}/{srr_atcc6538}.sra", \
                    srr_atcc6538 = config["SRR_ATCC6538"])
    conda: "envs/sra.yaml"
    threads: 1
    shell: "prefetch --output-directory data/sra/atcc6538 --option-file {input}"

rule sra_sh1000:
    input: "data/srr_sh1000.txt"
    output: expand("data/sra/sh1000/{srr_sh1000}/{srr_sh1000}.sra", \
                    srr_sh1000 = config["SRR_SH1000"])
    conda: "envs/sra.yaml"
    threads: 1
    shell: "prefetch --output-directory data/sra/sh1000 --option-file {input}"

rule sra_st398:
    input: "data/srr_st398.txt"
    output: expand("data/sra/st398/{srr_st398}/{srr_st398}.sra", \
                    srr_st398 = config["SRR_ST398"])
    conda: "envs/sra.yaml"
    threads: 1
    shell: "prefetch --output-directory data/sra/st398 --option-file {input}"

rule dump_sh1000:
    input: "data/sra/sh1000/{sample}"
    output: expand("data/sra/sh1000/{sample}_{mate}.fastq.gz", \
                    sra_accession = config["SRR"], mate = ["1", "2"])
    conda: "envs/dump.yaml"
    threads: 8
    shell: "parallel-fastq-dump --sra-id {input} --threads {threads} \
               --outdir data/sh1000 --split-files --gzip"

rule st398_snp:
    input:
        ref="data/st398.gbk",
        mate1="data/st398/{samprefix}_L001_R1_001.fastq.gz",
        mate2="data/st398/{samprefix}_L001_R2_001.fastq.gz"
    output:
        outd=directory("results/st398/{samprefix}"),
        rnl="results/st398/{samprefix}/{samprefix}.log"
    conda: "envs/snippy.yaml"
    threads: 10
    log: "logs/{samprefix}.txt"
    shell: "snippy --cpus {threads} \
		   --outdir {output.outd} \
		   --ref {input.ref} \
                   --prefix {wildcards.samprefix} \
		   --force \
		   --pe1 {input.mate1} --pe2 {input.mate2} 2> {log}"

rule atcc6538_snp:
    input:
        ref="data/atcc6538_combined.gbk",
        mate1="data/atcc6538/{samprefix}_L001_R1_001.fastq.gz",
        mate2="data/atcc6538/{samprefix}_L001_R2_001.fastq.gz"
    output:
        outd=directory("results/atcc6538/{samprefix}"),
        rnl="results/atcc6538/{samprefix}/{samprefix}.log"
    conda: "envs/snippy.yaml"
    threads: 10
    log: "logs/{samprefix}.txt"
    shell: "snippy --cpus {threads} \
		   --outdir {output.outd} \
		   --ref {input.ref} \
                   --prefix {wildcards.samprefix} \
		   --force \
		   --pe1 {input.mate1} --pe2 {input.mate2} 2> {log}"

rule sh1000_snp:
    input:
        ref="data/sh1000_dueppel.gbk",
        mate1="data/sh1000/{samprefix}_L001_R1_001.fastq.gz",
        mate2="data/sh1000/{samprefix}_L001_R2_001.fastq.gz"
    output:
        outd=directory("results/sh1000/{samprefix}"),
        rnl="results/sh1000/{samprefix}/{samprefix}.log"
    conda: "envs/snippy.yaml"
    threads: 10
    log: "logs/{samprefix}.txt"
    shell: "snippy --cpus {threads} \
		   --outdir {output.outd} \
		   --ref {input.ref} \
                   --prefix {wildcards.samprefix} \
		   --force \
		   --pe1 {input.mate1} --pe2 {input.mate2} 2> {log}"

rule growth_data:
    input: csv="data/20190906_growth_data.csv"
    output:
        "results/growth_data/20190906_gp_all.png",
        "results/growth_data/20190906_gp_no_sh.png",
	"results/growth_data/20190906_gp_sh.png",
	"results/growth_data/20190906_gp_sh_custom.png"
    conda: "envs/growth_data.yaml"
    threads: 1
    script: "scripts/growth_data.R"

